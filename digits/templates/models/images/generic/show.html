{# Copyright (c) 2015-2017, NVIDIA CORPORATION.  All rights reserved. #}

{% extends "job.html" %}
{% from "helper.html" import serve_file %}

{% block job_content %}

<script src="{{ url_for('static', filename='js/model-graphs.js', ver=dir_hash) }}"></script>

{% set task = job.train_task() %}

<div class="row">
    <div class="col-sm-6">
        <div class="well">
            <dl>
                <dt>Job Directory</dt>
                <dd>{{ job.dir() }}</dd>
                <dt>Disk Size</dt>
                <dd>{{job.disk_size_fmt()}}</dd>
                {% for key,value in task.get_model_files().items() %}
                <dt>{{key}}</dt>
                <dd>{{serve_file(task, value)}}</dd>
                {% endfor %}
                {% if task.log_file %}
                <dt>Raw {{task.get_framework_id()}} output</dt>
                <dd>{{serve_file(task, task.log_file)}}</dd>
                {% endif %}
                {% if task.pretrained_model %}
                <dt>Pretrained Model</dt>
                <dd>{{task.pretrained_model}}</dd>
                {% endif %}
                <dt>Visualizations</dt>
                <dd><a href="http://localhost:6006/" target="new">Tensorboard</a></dd>
            </dl>
        </div>
    </div>
    <div class="col-sm-6">
        <div class="well">
            <h4 class='text-center'>Dataset</h4>
            <div id="dataset-summary"></div>
            {% if job.dataset %}
            <script>
            $.ajax("/datasets/summary?job_id={{ job.dataset.id() }}",
            {
                type: "GET",
                }
            )
            .done(function(data) {
                $("#dataset-summary").html(data);
                })
            .fail(function(data) {
                $("#dataset-summary").html("");
                errorAlert(data);
                });
            </script>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-sm-12">
        <div class="well">
            <div id="combined-graph" class="combined-graph"
                style="height:500px;width:100%;background:white;display:none;"></div>
            <div class="pull-right combined-graph" style="display:none;">
                <a class="btn btn-primary btn-sm" target="_blank"
                    href="{{url_for('digits.model.images.generic.views.large_graph', job_id=job.id())}}">
                    View Large
                </a>
                {% if job.train_task().has_timeline_traces() %}
                <a class="btn btn-primary btn-sm" target="_blank"
                    href="{{url_for('digits.model.images.classification.views.timeline_tracing', job_id=job.id())}}">
                    View Timeline Traces
                </a>
                {% endif %}
            </div>
            <br>
            <br>
            {% set combined_graph_data = job.train_task().combined_graph_data() %}
            {% if combined_graph_data %}
            <script>
                drawCombinedGraph({% autoescape false %}{{combined_graph_data}}{% endautoescape %});
            </script>
            {% endif %}

            <div id="lr-graph" class="lr-graph"
                style="height:300px;width:100%;background:white;display:none;"></div>
            {% set lr_graph_data = job.train_task().lr_graph_data() %}
            {% if lr_graph_data %}
            <script>
                drawLRGraph({% autoescape false %}{{lr_graph_data}}{% endautoescape %});
            </script>
            {% endif %}

            {% set task = job.train_task() %}
            <hr>

            <form id="test-model-form"
                enctype="multipart/form-data"
                method="post"
                onkeypress="return event.keyCode != 13;" {# Disable enter to submit #}
                {#{% if not task.has_model() %}
                style="display:none;"
                {% endif %}#}
                >
                <!-- ////////////////////////////////////////////////////////////// -->
                <h2>Test Models</h2>
                <div class="row">
                    <div class="form-group">
                        <div class="col-sm-6">
                            <h3>Test Images</h3>
                            <div>
                                <div class="form-group">
                                    <button name="upload-db-btn"
                                        formaction="{{url_for('digits.model.images.generic.views.http_server')}}"
                                        formtarget="_blank"
                                        class="btn btn-info btn-file">
                                        Upload Sample Set
                                    </button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="sp_pic_dir" class="control-label">pictures path</label>
                                <span name="image_path_explanation"
                                    class="explanation-tooltip glyphicon glyphicon-question-sign"
                                    data-container="body"
                                    title="Can be a path on the server's pictures' folder."
                                ></span>
                                <input type="text" id="sp_pic_dir" name="sp_pic_dir" 
                                {% if last_sp_pic_dir %} value={{ last_sp_pic_dir }} {% endif %} class="form-control autocomplete_path">
                                <small>Specify path to sample pictures on server</small>
                            </div>

                            <div class="form-group">
                                <label for="test_server_addr" class="control-label">Test Server Address</label>
                                <div>
                                    <input type="text" id="test_server_ip" name="test_server_ip" class="col-sm-6" class="form-control autocomplete_path" placeholder="ip">
                                    <input type="text" id="test_server_port" name="test_server_port" class="col-sm-6" class="form-control autocomplete_path" placeholder="port">
                                    <small>Specify server address to run test model</small>
                                </div>
                            </div>

                            <div class="form-group">
                                <button name="infer-db-btn"
                                    formaction="{{url_for('digits.model.images.generic.views.get_label', job_id=job.id())}}"
                                    formmethod="post"
                                    formenctype="multipart/form-data"
                                    formtarget="_blank"
                                    class="btn btn-primary">
                                    Get Labels
                                </button>
                                
                            </div>

                            <div class="form-group">
                                <label for="gt_lbl_dir" class="control-label">ground truth labels path<i>(optional)</i></label>
                                <span name="label_path_explanation"
                                    class="explanation-tooltip glyphicon glyphicon-question-sign"
                                    data-container="body"
                                    title="Can be a path on the server's ground truth labels' folder, needed if analytical data is wanted"
                                ></span>
                                <input type="text" id="gt_lbl_dir" name="gt_lbl_dir" 
                                {% if last_gt_lbl_dir %} value={{ last_gt_lbl_dir }} {% endif %} class="form-control autocomplete_path">
                                <small>Specify path to ground turth labels on server</small><br>
                            </div>

                            <div class="form-group">
                                <button name="infer-db-btn"
                                    formaction="{{url_for('digits.model.images.generic.views.show_sample', job_id=job.id())}}"
                                    formmethod="post"
                                    formenctype="multipart/form-data"
                                    formtarget="_blank"
                                    class="btn btn-info btn-file">
                                    Show Images
                                </button>
                                
                            </div>



                        </div>

                        <div class="col-sm-6">
                            <h3>Performance</h3>
                            <div class="form-group">
                                <button name="infer-db-btn"
                                    formaction="{{url_for('digits.model.images.generic.views.cal_performance_data', job_id=job.id())}}"
                                    formmethod="post"
                                    formenctype="multipart/form-data"
                                    class="btn btn-primary">
                                    Get Performance
                                </button>
                            </div>
                            <div class="form-group">
                                <label for="performance_class" class="control-label">class statistical data</label>
                                <select id="performance_class" name="performance_class" class="form-control" data-edit-select="None" >
                                        <option value="None">{{performance_heading}}</option>
                                    {% for key in performance_data|sort %}
                                        <option value="{{ key }}">{{ key }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="performance_data_show">
                                
                            </div>

                            <script>
                                {% for key in performance_data|sort %}
                                    var {{ key }} = "<pre>{{performance_data[key]|safe}}</pre>";
                                {% endfor %}
                                
                                var choose = document.getElementById('performance_class');
                                var content = document.getElementsByClassName('performance_data_show')[0];
                                choose.addEventListener('change', function () {
                                        if( choose.value == 'None' ){
                                            content.innerHTML = '';
                                        }
                                    {% for key in performance_data|sort %}
                                        if( choose.value == '{{ key }}' ){
                                            content.innerHTML = {{ key }};
                                        }
                                    {% endfor %}
                                });
                            </script>
                        </div>


                    </div>
                </div>
                <!-- //////////////////////////////////////////////////////////////// -->
            </form>
        </div>
    </div>
</div>

<script>
$("#data_extension_id").change(function() {
    if ($(this).val()) {

        $.ajax("/datasets/inference-form/" + $(this).val() + "/" + "{{ job.dataset.id() }}",
            {
                type: "GET",
                }
            )
        .done(function(data) {
                if (data.length > 0)
                {
                    $("#default-inference-form").hide();
                    $("#custom-inference-form-html").html(data);
                    $("#custom-inference-form-html").show();
                }
                else
                {
                    $("#custom-inference-form-html").hide();
                    $("#default-inference-form").show();
                }
            })
        .fail(function(data) {
            $("#custom-inference-form-html").html("");
            errorAlert(data);
            });
        }
    });
$("#data_extension_id").change();
</script>

{% endblock %}
